## Android 渲染

### Android 绘制原理

Android系统每16ms都会重新绘制一次你的Activity，也就是说，你的逻辑控制画面更新要保证最多16ms一帧才能每秒达到60帧。但是如果你的应用程序没有在16ms内完成这一帧的绘制，假设你花费了24ms来绘制这一帧，那么就会出现我们称之为**掉帧**的情况，世界变得有延迟了。系统准备将新的一帧绘制到屏幕上，但是这一帧并没有准备好，所有就不会有绘制操作，画面也就不会刷新。反馈到用户身上，就是用户盯着同一张图看了32ms而不是16ms，也就是说掉帧发生了。

### 掉帧

引起掉帧发生的原因非常多：

1. Too much view

   你花了太多的时间重新绘制你视图中的大部分东西，这样非常浪费CPU周期

2. Draw hidden view

   你有太多的对象堆叠到了一起，你在绘制用户看不到的对象上花费了太多的时间

3. Too much animations

   你有一大堆的动画重复了一遍又一遍，导致CPU和GPU组件的大量浪费

#### OverDraw

**OverDraw**是一个术语, 它表示某些组件在屏幕上的一个像素点的绘制超过1次.例如我们有一堆重叠的卡片,被用户激活的卡片在最上面,而那些没有激活的卡片在下面,这意味着我们画大力气绘制的那些卡片,基本都是不可见的.问题就在于次,我们像素渲染的并不全是用户最后能看打的部分, 这是在浪费GPU的时间!

#### VSYNC

即垂直同步，解决帧速率和刷新率不一致时出现的撕裂问题。

刷新率，代表屏幕在一秒内刷新屏幕的次数，这个值用赫兹来表示，取决于硬件的固定参数。

帧速率，代表了GPU在一秒内绘制操作的帧数，这个值用 fps 表示。

#### 检测和解决

1. Hierarchy View

   使用它来查看 View 是否过于复杂

2. Trace View

   Android Studio 中使用 Profiler 记录一段时间的 CPU 运行区间，会生成一个 trace 文件，从中可以检查是否掉帧

3. On Device tool

   进入开发者选项，开启Profile GPU Rendering 和 GPU Overdraw